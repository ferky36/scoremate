"use strict";

// Match Recap: builds a quick summary from current UI/locals (no Supabase fetch)
(function(){
  function byId(id){ return document.getElementById(id); }

  function ensureRecapButton(){
    const standings = byId('standings');
    if (!standings) return;
    const hostSection = standings.closest('section') || standings.parentElement;
    if (!hostSection) return;

    if (byId('btnMatchRecap')) return; // already inserted

    const wrap = document.createElement('div');
    wrap.className = 'mt-4 flex items-center justify-end';

    const btn = document.createElement('button');
    btn.id = 'btnMatchRecap';
    btn.className = 'recap-btn';
    btn.textContent = 'Match Recap';
    btn.addEventListener('click', openRecapModal);
    wrap.appendChild(btn);

    hostSection.appendChild(wrap);
  }

  async function openRecapModal(){
    // Ensure insight templates are loaded before first render
    try { await loadInsightTemplates?.(); } catch {}

    const modal = buildModalShell();
    document.body.appendChild(modal.backdrop);
    modal.backdrop.offsetHeight; // force reflow for animation
    modal.backdrop.classList.add('open');

    const content = buildRecapContent();
    modal.content.innerHTML = '';
    modal.content.appendChild(content);
  }

  function closeRecapModal(){
    const el = byId('matchRecapOverlay');
    if (!el) return;
    el.classList.remove('open');
    setTimeout(()=> el.remove(), 150);
  }

  function buildModalShell(){
    const t = (k,f)=> (window.__i18n_get ? window.__i18n_get(k,f) : f);
    const overlay = document.createElement('div');
    overlay.id = 'matchRecapOverlay';
    overlay.className = 'recap-overlay';

    const panel = document.createElement('div');
    panel.className = 'recap-panel';

    const header = document.createElement('div');
    header.className = 'recap-header';
    const title = document.createElement('div');
    title.className = 'recap-title';
    title.innerHTML = `<div class="text-xs uppercase tracking-wide text-indigo-100 mb-1">${t('recap.subtitle','Rangkuman')}</div><div class="text-lg font-bold text-white">${t('recap.title','Match Recap')}</div>`;
    const actions = document.createElement('div');
    actions.className = 'recap-actions';
    const saveBtn = document.createElement('button');
    saveBtn.className = 'recap-action';
    saveBtn.innerHTML = '<span>ðŸ’¾</span><span>Simpan gambar</span>';
    saveBtn.addEventListener('click', ()=> saveRecapAsImage());
    const copyBtn = document.createElement('button');
    copyBtn.className = 'recap-action';
    copyBtn.innerHTML = '<span>ðŸ“‹</span><span>Salin teks</span>';
    copyBtn.addEventListener('click', copyRecapText);
    const closeBtn = document.createElement('button');
    closeBtn.className = 'recap-action';
    closeBtn.innerHTML = '<span>âœ•</span><span>Tutup</span>';
    closeBtn.addEventListener('click', closeRecapModal);
    actions.appendChild(saveBtn);
    actions.appendChild(copyBtn);
    actions.appendChild(closeBtn);
    header.appendChild(title);
    header.appendChild(actions);

    const body = document.createElement('div');
    body.className = 'recap-body';

    panel.appendChild(header);
    panel.appendChild(body);
    overlay.appendChild(panel);

    overlay.addEventListener('click', (e)=>{ if (e.target === overlay) closeRecapModal(); });

    return { backdrop: overlay, content: body };
  }

  function textFrom(el){ return (el?.textContent || '').trim(); }

  function buildRecapContent(){
    const root = document.createElement('div');

    // Collect data
    const matches = collectMatches().map(m=>{
      const saN = Number(m.sa||0), sbN = Number(m.sb||0);
      const margin = Math.abs(saN - sbN);
      const winner = saN===sbN ? 'D' : (saN>sbN?'A':'B');
      return {...m, saN, sbN, margin, winner};
    });

    // Standings snapshot (from DOM table)
    const standingsEl = byId('standings');
    const standingRows = [...(standingsEl?.querySelectorAll('tbody tr') || [])];
    const standings = standingRows.map(tr => {
      const t = [...tr.children].map(td => textFrom(td));
      const rank = Number(t[0]||0);
      const player = t[1]||'';
      const pf = Number(t[2]||0);
      const diff = Number(t[3]||0);
      const w = Number(t[4]||0), l = Number(t[5]||0), d = Number(t[6]||0);
      const gp = w+l+d;
      const pa = pf - diff;
      return {rank, player, gp, w, l, pf, pa, diff};
    }).filter(x=>x.player);

    // Header title
    const courtNo = (typeof activeCourt !== 'undefined') ? (Number(activeCourt)+1) : (Number(window.activeCourt||0)+1);
    const headerTitle = `${textFrom(byId('appTitle')) || 'Match Recap'} â€” Court ${courtNo}`;
    const hdr = document.createElement('div');
    hdr.className = 'recap-titlebar';
    hdr.textContent = headerTitle;
    root.appendChild(hdr);

    // Stat cards
    const totalMatch = matches.length;
    const totalPoint = matches.reduce((s,m)=>s+m.saN+m.sbN,0);
    const avgMargin = totalMatch ? (matches.reduce((s,m)=>s+m.margin,0)/totalMatch) : 0;
    const tight = matches.length ? matches.slice().sort((a,b)=>a.margin-b.margin || a.round-b.round)[0] : null;
    const cards = document.createElement('div');
    cards.className = 'recap-cards';
    const tightLabel = tight ? `Match ${tight.round} (${tight.teamA} vs ${tight.teamB || '-'})` : 'Belum ada';
    cards.innerHTML = `
      ${cardMetric(totalMatch, 'Total Match', 'Berapa banyak laga sudah dimainkan.')}
      ${cardMetric(totalPoint, 'Total Poin', 'Akumulasi poin semua match (A+B).')}
      ${cardMetric(avgMargin.toFixed(1), 'Rata Selisih', 'Rata-rata margin skor per match.')}
      ${tight ? cardMetric(`${tight.saN}â€“${tight.sbN}`, `Paling Ketat`, `Terketat: ${tightLabel}`) : cardMetric('-', 'Paling Ketat', 'Menunggu skor terisi.')}
    `;
    root.appendChild(cards);

    // Two-column layout
    const grid = document.createElement('div');
    grid.className = 'recap-grid';

